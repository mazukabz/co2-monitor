# =============================================================================
# CO2 Monitor - Docker Compose
# =============================================================================
# ПОРТЫ (из Infisical, НЕ МЕНЯТЬ без согласования):
#   - DB_EXTERNAL_PORT=10532  (PostgreSQL для внешнего доступа)
#   - MQTT_PORT=10883         (MQTT для устройств)
#   - API_PORT=10900          (API для будущего веб-интерфейса)
# =============================================================================

services:
  co2_db:
    image: postgres:16-alpine
    container_name: co2_db
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      TZ: ${TZ:-Europe/Moscow}
    ports:
      # Внешний порт из Infisical, внутренний всегда 5432
      - "${DB_EXTERNAL_PORT:-10532}:5432"
    volumes:
      - co2_postgres_data:/var/lib/postgresql/data
    networks:
      - co2-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  co2_mqtt:
    image: eclipse-mosquitto:2
    container_name: co2_mqtt
    ports:
      # Внешний порт из Infisical (для устройств), внутренний всегда 1883
      - "${MQTT_PORT:-10883}:1883"
    volumes:
      - ./mosquitto/config:/mosquitto/config:ro
      - co2_mqtt_data:/mosquitto/data
      - co2_mqtt_log:/mosquitto/log
    networks:
      - co2-network
    restart: unless-stopped

  co2_processor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: co2_processor
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - BOT_TOKEN=${BOT_TOKEN}  # Для отправки уведомлений о превышении CO2
      - MQTT_BROKER=co2_mqtt
      - MQTT_PORT=1883  # Внутренний порт Docker, НЕ внешний!
      - TZ=${TZ:-Europe/Moscow}
    depends_on:
      co2_db:
        condition: service_healthy
      co2_mqtt:
        condition: service_started
    networks:
      - co2-network
    restart: unless-stopped
    command: python -m app.mqtt.main

  co2_bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: co2_bot
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - BOT_TOKEN=${BOT_TOKEN}
      - ADMIN_USER_IDS=${ADMIN_USER_IDS}
      - MQTT_BROKER=co2_mqtt
      - MQTT_PORT=1883  # Внутренний порт Docker, НЕ внешний!
      - TZ=${TZ:-Europe/Moscow}
    depends_on:
      co2_db:
        condition: service_healthy
      co2_mqtt:
        condition: service_started
      co2_processor:
        condition: service_started
    networks:
      - co2-network
    restart: unless-stopped
    command: python -m app.bot.main

  # API сервис - OTA updates для устройств
  co2_api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: co2_api
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - MQTT_BROKER=co2_mqtt
      - MQTT_EXTERNAL_PORT=${MQTT_EXTERNAL_PORT}
      - MQTT_PUBLIC_HOST=${SSH_HOST}
      - TZ=${TZ:-Europe/Moscow}
    ports:
      # Внешний порт из Infisical, внутренний 8000
      - "${API_PORT:-10900}:8000"
    volumes:
      # Mount device scripts for OTA delivery
      - ./device:/app/device:ro
    depends_on:
      co2_db:
        condition: service_healthy
    networks:
      - co2-network
    restart: unless-stopped
    command: uvicorn app.api.main:app --host 0.0.0.0 --port 8000

networks:
  co2-network:
    name: co2-network
    driver: bridge

volumes:
  co2_postgres_data:
    name: co2_postgres_data
  co2_mqtt_data:
    name: co2_mqtt_data
  co2_mqtt_log:
    name: co2_mqtt_log
