# CO2 Monitor v1.2

Система мониторинга CO2 с Telegram ботом, инфографиками и автоматическими отчётами.

## Архитектура

```
┌─────────────────┐     MQTT      ┌──────────────────┐
│  Raspberry Pi   │──────────────▶│   MQTT Broker    │
│  + MH-Z19/DHT22 │               │   (Mosquitto)    │
└─────────────────┘               └────────┬─────────┘
                                           │
                                           ▼
┌─────────────────┐               ┌──────────────────┐
│  Telegram Bot   │◀──────────────│  MQTT Processor  │
│  (aiogram 3.x)  │               │  (saves to DB)   │
└────────┬────────┘               └────────┬─────────┘
         │                                 │
         ▼                                 ▼
┌─────────────────┐               ┌──────────────────┐
│   Scheduler     │──────────────▶│   PostgreSQL     │
│ (reports/alerts)│               │   (telemetry)    │
└─────────────────┘               └──────────────────┘
```

## Компоненты

| Сервис | Порт | Описание |
|--------|------|----------|
| `co2_mqtt` | - | MQTT процессор, сохраняет телеметрию в БД |
| `co2_bot` | - | Telegram бот + планировщик отчётов |
| `co2_api` | 10900 | API для OTA обновлений устройств |
| `co2_db` | 10532 | PostgreSQL база данных |
| `mqtt` | 10883 | MQTT брокер Mosquitto |

## Возможности

### Telegram бот

**Основные команды:**
- `/start` — начало работы, показ ID
- `/status` — текущие показания CO2/температуры/влажности
- `/devices` — список привязанных устройств
- `/bind` — привязка устройства по коду активации

**Графики и отчёты:**
- `/report` — отчёт за 24 часа с инфографикой
- `/morning` — ночной отчёт (22:00-08:00) с оценкой качества сна
- `/evening` — дневной отчёт (08:00-22:00) со статистикой

**Настройки:**
- `/settings` — настройки уведомлений
  - Включение/выключение оповещений
  - Порог CO2 для оповещений
  - Время утреннего/вечернего отчёта

**Админ-панель:**
- `/admin` — статистика и управление устройствами
  - Изменение интервала отправки данных (30/60/120/300 сек)
  - MQTT push конфигурации на устройство

### Автоматические отчёты

Планировщик отправляет отчёты по расписанию пользователя:
- **Утренний отчёт** (по умолчанию 08:00) — анализ ночного сна
- **Вечерний отчёт** (по умолчанию 22:00) — итоги дня

### Инфографики

Генерация графиков на сервере (matplotlib) в стиле Apple Stocks:
- Тёмная тема с градиентными заливками
- Многоцветная линия по уровню CO2 (зелёный/жёлтый/оранжевый/красный)
- Зоны: отлично (<800), хорошо (800-1000), проветрить (1000-1500), критично (>1500)
- Карточки со статистикой (среднее, мин, макс)
- Графики температуры и влажности

### Устройства

Поддержка Raspberry Pi с датчиками:
- **MH-Z19** — CO2 (UART)
- **DHT22/AM2302** — температура + влажность
- **BME280** — температура + влажность + давление (I2C)

Установка одной командой:
```bash
curl -sL http://31.59.170.64:10900/install.py | python3
```

## Структура проекта

```
v1.2/
├── app/
│   ├── api/           # FastAPI для OTA обновлений
│   ├── bot/           # Telegram бот (aiogram)
│   ├── core/          # Конфигурация, база данных
│   ├── models/        # SQLAlchemy модели
│   ├── mqtt/          # MQTT процессор
│   └── services/      # Бизнес-логика
│       ├── charts.py      # Генерация инфографик
│       └── scheduler.py   # Планировщик отчётов
├── alembic/           # Миграции БД
├── device/            # Прошивка устройства
├── docker-compose.yml
├── requirements.txt
├── INFISICAL.md       # Документация по секретам
└── README.md          # Этот файл
```

## База данных

### Таблицы

| Таблица | Описание |
|---------|----------|
| `users` | Пользователи Telegram (настройки уведомлений) |
| `devices` | Устройства (UID, код активации, интервал) |
| `telemetry` | Показания датчиков (CO2, температура, влажность) |

### Модель User

```python
- telegram_id: int (unique)
- timezone: str (default "Europe/Moscow")
- alerts_enabled: bool
- alert_threshold: int (default 1000 ppm)
- morning_report_enabled: bool
- morning_report_time: time (default 08:00)
- evening_report_enabled: bool
- evening_report_time: time (default 22:00)
```

### Модель Device

```python
- device_uid: str (unique)
- activation_code: str (8 символов)
- send_interval: int (секунды, default 60)
- owner_telegram_id: int (FK → users)
- is_online: bool
- last_seen: datetime
- firmware_version: str
```

### Модель Telemetry

```python
- device_id: int (FK → devices)
- co2: int (ppm)
- temperature: float (°C)
- humidity: float (%)
- timestamp: datetime
```

## Деплой

### GitHub Actions

Автоматический деплой при push в `main`:
1. Подключение к серверу по SSH
2. `git pull`
3. `./start.sh` (загружает секреты из Infisical)
4. `docker compose up -d --build`
5. Миграции БД

### Ручной деплой

```bash
ssh root@31.59.170.64
cd /opt/apps/co2
./start.sh
docker exec -it co2_mqtt alembic upgrade head
```

## Секреты

Все секреты хранятся в **Infisical Cloud EU**.

См. [INFISICAL.md](INFISICAL.md) для подробностей.

Основные переменные:
- `BOT_TOKEN` — токен Telegram бота
- `POSTGRES_PASSWORD` — пароль PostgreSQL
- `MQTT_EXTERNAL_PORT` — внешний порт MQTT (10883)
- `ADMIN_USER_IDS` — ID администраторов

## Бэклог

### Высокий приоритет
- [ ] Политика хранения данных (удаление записей старше N дней)
- [ ] Агрегация данных для долгосрочного хранения (почасовые/дневные средние)
- [ ] Оповещения при превышении порога CO2 (push в Telegram)

### Средний приоритет
- [ ] `/live` — режим реального времени (обновление сообщения каждые N секунд)
- [ ] `/week` — недельный отчёт с графиком и трендами
- [ ] Экспорт данных в CSV/JSON
- [ ] Сравнение периодов (неделя к неделе)

### Идеи на будущее
- [ ] Веб-интерфейс с дашбордом (React/Vue)
- [ ] Интеграция с Home Assistant (MQTT discovery)
- [ ] Поддержка нескольких часовых поясов в одном отчёте
- [ ] Прогнозирование уровня CO2 (ML)
- [ ] Рекомендации по проветриванию на основе погоды

## Версии

### v1.2.3 (текущая)
- Многоцветный график CO2 в стиле Apple Stocks
- Цвет линии и заливки меняется по уровню CO2 (зелёный → жёлтый → оранжевый → красный)

### v1.2.2
- Команда `/report` — полный отчёт за 24 часа с детальной инфографикой
- Удалена дублирующая команда `/chart`
- Исправлена кнопка "Назад" в админ-панели

### v1.2.1
- Инфографики (matplotlib + seaborn)
- Команды `/morning`, `/evening`
- Настройки уведомлений `/settings`
- Планировщик автоматических отчётов
- Управление интервалом устройств через бота
- MQTT push конфигурации на устройства

### v1.2.0
- Поддержка часовых поясов пользователей
- Исправлен тип Telegram ID (BigInteger)
- MQTT_EXTERNAL_PORT из Infisical

### v1.1.0
- Привязка устройств по коду активации
- OTA обновления прошивки

### v1.0.0
- Базовый функционал бота
- MQTT телеметрия
- PostgreSQL хранение

## Лицензия

MIT
