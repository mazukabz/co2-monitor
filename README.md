# CO2 Monitor v1.2.5

Система мониторинга CO2 с Telegram ботом, инфографиками и автоматическими отчётами.

## Архитектура

```
┌─────────────────┐     MQTT      ┌──────────────────┐
│  Raspberry Pi   │──────────────▶│   MQTT Broker    │
│  + MH-Z19/DHT22 │               │   (Mosquitto)    │
└─────────────────┘               └────────┬─────────┘
                                           │
                                           ▼
┌─────────────────┐               ┌──────────────────┐
│  Telegram Bot   │◀──────────────│  MQTT Processor  │
│  (aiogram 3.x)  │               │  (saves to DB)   │
└────────┬────────┘               └────────┬─────────┘
         │                                 │
         ▼                                 ▼
┌─────────────────┐               ┌──────────────────┐
│   Scheduler     │──────────────▶│   PostgreSQL     │
│ (reports/alerts)│               │   (telemetry)    │
└─────────────────┘               └──────────────────┘
```

## Компоненты

| Сервис | Порт | Описание |
|--------|------|----------|
| `co2_mqtt` | - | MQTT процессор, сохраняет телеметрию в БД |
| `co2_bot` | - | Telegram бот + планировщик отчётов |
| `co2_api` | 10900 | API для OTA обновлений устройств |
| `co2_db` | 10532 | PostgreSQL база данных |
| `mqtt` | 10883 | MQTT брокер Mosquitto |

## Возможности

### Telegram бот

**Интерфейс:**
Бот использует постоянное меню внизу экрана (4 кнопки) + команды в меню Telegram (☰).

**Постоянное меню (всегда видно):**
```
┌──────────────┬──────────────┐
│ 📊 Статус    │ 📈 Отчёт     │
├──────────────┼──────────────┤
│ ⚙️ Настройки │ ❓ Помощь    │
└──────────────┴──────────────┘
```

**Команды (меню ☰):**
| Команда | Описание |
|---------|----------|
| `/start` | Начать работу, показать главное меню |
| `/status` | Текущие показания CO2/температуры/влажности |
| `/report` | Отчёт за период (1ч/6ч/12ч/24ч/7д/30д) + ночной/дневной |
| `/devices` | Список привязанных устройств |
| `/bind` | Привязка устройства по коду активации |
| `/settings` | Настройки уведомлений |
| `/help` | Справка по боту |
| `/admin` | Админ-панель (только для администраторов) |

**Выбор периода отчёта:**
При нажатии на 📈 Отчёт или `/report` появляется меню выбора:
- 1 час, 6 часов, 12 часов, 24 часа, 7 дней, 30 дней
- 🌙 Ночной (22:00-08:00) — с оценкой качества сна
- ☀️ Дневной (08:00-22:00) — итоги дня

**Настройки пользователя:**
- Включение/выключение оповещений
- Порог CO2 для оповещений (400-5000 ppm)
- Время утреннего отчёта (по умолчанию 08:00)
- Время вечернего отчёта (по умолчанию 22:00)

**Админ-панель:**
- Статистика пользователей и устройств
- Управление интервалом отправки данных (30/60/120/300 сек)
- MQTT push конфигурации на устройство

### Автоматические отчёты

Планировщик отправляет отчёты по расписанию пользователя:
- **Утренний отчёт** (по умолчанию 08:00) — анализ ночного сна
- **Вечерний отчёт** (по умолчанию 22:00) — итоги дня

### Инфографики

Генерация графиков на сервере (matplotlib + scipy) в стиле Apple Stocks:
- Тёмная тема (#000000) с градиентными заливками
- Многоцветная линия по уровню CO2 (зелёный → жёлтый → оранжевый → красный)
- Сглаживание графиков (spline интерполяция + агрегация)
- Мобильно-оптимизированные шрифты (96pt заголовок, 48pt статистика)
- Динамический Y-axis с 15% padding
- Карточки со статистикой (среднее, мин, макс)
- Информация о температуре и влажности

**Зоны качества воздуха:**
- 🟢 < 800 ppm — Отлично
- 🟡 800-1000 ppm — Хорошо
- 🟠 1000-1500 ppm — Проветрите
- 🔴 > 1500 ppm — Критично

**Правила сглаживания графиков:**
| Период | Агрегация | Точки сплайна |
|--------|-----------|---------------|
| 1 час | 2 точки | 50 |
| 6 часов | 4 точки | 80 |
| 12-24 часа | 6 точек | 100 |
| 7 дней | 12 точек | 120 |
| 30 дней | 24 точки | 150 |

### Устройства

Поддержка Raspberry Pi с датчиками:
- **MH-Z19** — CO2 (UART)
- **DHT22/AM2302** — температура + влажность
- **BME280** — температура + влажность + давление (I2C)

Установка одной командой:
```bash
curl -sL http://31.59.170.64:10900/install.py | python3
```

## Структура проекта

```
v1.2/
├── app/
│   ├── api/           # FastAPI для OTA обновлений
│   ├── bot/           # Telegram бот (aiogram 3.x)
│   │   └── main.py    # Обработчики команд и меню
│   ├── core/          # Конфигурация, база данных
│   ├── models/        # SQLAlchemy модели
│   ├── mqtt/          # MQTT процессор
│   └── services/      # Бизнес-логика
│       ├── charts.py      # Генерация инфографик (Apple Stocks style)
│       └── scheduler.py   # Планировщик автоотчётов
├── alembic/           # Миграции БД
├── device/            # Прошивка устройства
├── docker-compose.yml
├── requirements.txt
├── INFISICAL.md       # Документация по секретам
└── README.md          # Этот файл
```

## База данных

### Таблицы

| Таблица | Описание |
|---------|----------|
| `users` | Пользователи Telegram (настройки уведомлений) |
| `devices` | Устройства (UID, код активации, интервал) |
| `telemetry` | Показания датчиков (CO2, температура, влажность) |

### Модель User

```python
- telegram_id: int (unique, BigInteger)
- timezone: str (default "Europe/Moscow")
- alerts_enabled: bool (default True)
- alert_threshold: int (default 1000 ppm)
- morning_report_enabled: bool (default True)
- morning_report_time: time (default 08:00)
- evening_report_enabled: bool (default True)
- evening_report_time: time (default 22:00)
```

### Модель Device

```python
- device_uid: str (unique)
- activation_code: str (8 символов)
- send_interval: int (секунды, default 60)
- owner_telegram_id: int (FK → users, BigInteger)
- is_online: bool
- last_seen: datetime
- firmware_version: str
```

### Модель Telemetry

```python
- device_id: int (FK → devices)
- co2: int (ppm)
- temperature: float (°C)
- humidity: float (%)
- timestamp: datetime
```

## Деплой

### GitHub Actions

Автоматический деплой при push в `main`:
1. Подключение к серверу по SSH
2. `git pull`
3. `./start.sh` (загружает секреты из Infisical)
4. `docker compose up -d --build`
5. Миграции БД

### Ручной деплой

```bash
ssh root@31.59.170.64
cd /opt/apps/co2
./start.sh
docker exec -it co2_mqtt alembic upgrade head
```

## Секреты

Все секреты хранятся в **Infisical Cloud EU**.

См. [INFISICAL.md](INFISICAL.md) для подробностей.

Основные переменные:
- `BOT_TOKEN` — токен Telegram бота
- `POSTGRES_PASSWORD` — пароль PostgreSQL
- `MQTT_EXTERNAL_PORT` — внешний порт MQTT (10883)
- `ADMIN_USER_IDS` — ID администраторов (через запятую)

## Зависимости

```
# Database
sqlalchemy[asyncio]==2.0.23
asyncpg==0.29.0
alembic==1.13.1

# Telegram Bot
aiogram==3.3.0

# MQTT
paho-mqtt==2.0.0

# API Server
fastapi==0.109.0
uvicorn[standard]==0.27.0

# Charts & Infographics
matplotlib==3.8.2
seaborn==0.13.1
scipy==1.11.4
```

## Бэклог

### Высокий приоритет
- [ ] Починить вывод на дисплей устройства (сейчас не работает)
- [ ] `/history` — список показаний за период (усреднённые, макс 12/24 записи)
- [ ] Политика хранения данных (удаление записей старше N дней)
- [ ] Агрегация данных для долгосрочного хранения (почасовые/дневные средние)
- [ ] Оповещения при превышении порога CO2 (push в Telegram)

### Средний приоритет
- [ ] Экспорт данных в CSV/JSON
- [ ] Сравнение периодов (неделя к неделе)

### Идеи на будущее
- [ ] Веб-сайт с дашбордом
- [ ] Мобильное приложение (iOS, Android)
- [ ] Интеграция с Home Assistant (MQTT discovery)
- [ ] Прогнозирование уровня CO2 (ML)
- [ ] Рекомендации по проветриванию на основе погоды

## История версий

### v1.2.5 (текущая)
- `/live` — режим реального времени с автообновлением каждые 5 сек
- Исправлен статус устройств (offline если пропущено 3 отправки)
- Показывается время последних данных ("5 мин назад")
- Предупреждение если устройство не в сети с последними данными

### v1.2.4
- Постоянное меню внизу экрана (ReplyKeyboardMarkup с is_persistent)
- Регистрация команд в меню Telegram (set_my_commands)
- Объединены команды и кнопки меню
- Удалены дублирующие команды (/morning, /evening, /menu)
- Ночной/Дневной отчёт доступны через inline кнопки в /report
- Улучшенное сглаживание графиков (агрегация + spline по периодам)

### v1.2.3
- Многоцветный график CO2 в стиле Apple Stocks
- Цвет линии и заливки меняется по уровню CO2
- Мобильно-оптимизированные шрифты

### v1.2.2
- Команда `/report` — полный отчёт за 24 часа с детальной инфографикой
- Удалена дублирующая команда `/chart`
- Исправлена кнопка "Назад" в админ-панели

### v1.2.1
- Инфографики (matplotlib + seaborn)
- Команды `/morning`, `/evening`
- Настройки уведомлений `/settings`
- Планировщик автоматических отчётов
- Управление интервалом устройств через бота
- MQTT push конфигурации на устройства

### v1.2.0
- Поддержка часовых поясов пользователей
- Исправлен тип Telegram ID (BigInteger)
- MQTT_EXTERNAL_PORT из Infisical

### v1.1.0
- Привязка устройств по коду активации
- OTA обновления прошивки

### v1.0.0
- Базовый функционал бота
- MQTT телеметрия
- PostgreSQL хранение

## Лицензия

MIT
